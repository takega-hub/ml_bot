# ML Trading Bot — приложение для iPhone

Мобильное приложение с полным функционалом Telegram-админки: управление ботом, настройки пар и риска, ML-настройки, выбор и переобучение моделей, история сделок и сигналов, логи, экстренные действия, а также аналитика с визуализацией PnL (кривая капитала).

## Требования

- Xcode 15+
- iOS 16+
- Запущенный бот с включённым REST API (см. раздел «Настройка бота»)

## Создание проекта в Xcode

1. Откройте Xcode → **File → New → Project**.
2. Выберите **App** (iOS), нажмите **Next**.
3. Укажите:
   - **Product Name:** MLBot
   - **Team:** ваш Apple Developer Team
   - **Organization Identifier:** например `com.yourname`
   - **Interface:** SwiftUI
   - **Language:** Swift
   - **Storage:** None
4. Сохраните проект в папку `ios_app/MLBot` (или рядом с папкой `MLBot` из этого репозитория).
5. Удалите автоматически созданный файл `ContentView.swift` (если он один и тот же по смыслу — замените его содержимым из этого репозитория).
6. Добавьте в проект все файлы из папки `MLBotApp` этого репозитория:
   - Перетащите папку `MLBotApp` в навигатор проекта Xcode.
   - Отметьте **Copy items if needed** и добавьте в target приложения.

Либо склонируйте только папку `MLBotApp` в уже созданный проект и добавьте файлы в target.

## Настройка бота (API)

В `.env` на сервере, где запущен бот, добавьте:

```env
# Ключ для мобильного приложения (придумайте свой секретный ключ)
MOBILE_API_KEY=d44f6467fdb55f9dd22eaadc12c611bc

# Порт API (по умолчанию 8765)
MOBILE_API_PORT=8765
```

Если `MOBILE_API_KEY` не задан, будет использоваться `ALLOWED_USER_ID` (ваш Telegram ID) как ключ.

Перезапустите бота. API будет доступен по адресу: `http://IP_СЕРВЕРА:8765`.

## Настройка приложения

1. При первом запуске откройте **Настройки** (иконка шестерёнки).
2. Укажите **URL сервера**, например:
   - Локальная сеть: `http://192.168.1.100:8765`
   - Через туннель (ngrok): `https://xxxx.ngrok.io`
3. Введите **API ключ** (значение `MOBILE_API_KEY` из `.env` или ваш Telegram ID).
4. Нажмите **Сохранить**.

Для доступа с телефона к боту на домашнем ПК используйте туннель (ngrok, Cloudflare Tunnel) или VPN в локальную сеть.

**Важно (HTTP):** если сервер доступен по HTTP (без SSL), в Xcode откройте **Info** таргета → добавьте ключ **App Transport Security Settings** → **Allow Arbitrary Loads** = **YES** (или добавьте исключение только для вашего хоста). Иначе iOS заблокирует запросы.

## Безопасность

- Не используйте один и тот же ключ в незащищённых сетях.
- Для доступа через интернет поднимите HTTPS (обратный прокси с SSL) и по возможности ограничьте доступ по IP или дополнительной аутентификации.

## Структура

- **MLBotApp/** — точка входа приложения.
- **ContentView** — главный экран с вкладками.
- **APIClient** — запросы к REST API бота.
- **Views/** — экраны: Статус, Дашборд, Управление (Старт/Стоп), Настройки.

## Функционал приложения

- **Главная (меню как в Telegram):** Старт/Стоп, Статус, Статистика, Настройки пар, Модели, Настройки риска, ML настройки, История, Экстренные, Аналитика.
- **Настройки пар:** Включение/выключение пар, снятие cooldown, добавление новой пары.
- **Модели:** Список моделей по символу, применение модели, переобучение в фоне.
- **История:** Сделки, сигналы, логи (бот/сделки/сигналы/ошибки).
- **Аналитика:** Кривая капитала (график накопленного PnL по сделкам). Требуется iOS 16+ (Swift Charts).

## API эндпоинты (для справки)

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/api/health` | Проверка доступности (без ключа) |
| GET | `/api/status` | Полный статус, позиции, стратегии |
| GET | `/api/dashboard` | Сводка: баланс, PnL за день/неделю |
| POST | `/api/start` | Запуск бота |
| POST | `/api/stop` | Остановка бота |
| GET/PUT | `/api/pairs`, `/api/risk`, `/api/ml` | Пары, риск, ML |
| GET/POST | `/api/models`, `/api/models/{symbol}`, `/api/models/retrain` | Модели |
| GET | `/api/history/trades`, `/api/history/signals`, `/api/logs` | История и логи |
| GET | `/api/analytics/equity_curve` | Кривая капитала для графика PnL |
| POST | `/api/emergency/stop_all` | Стоп и закрыть все позиции |

Во всех запросах (кроме `/api/health`) передавайте заголовок: `X-API-Key: ваш_ключ`.
