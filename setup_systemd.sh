#!/bin/bash
# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ systemd service

set -e

echo "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° systemd service Ð´Ð»Ñ ML Trading Bot..."

# ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¿ÑƒÑ‚Ð¸ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WORKING_DIR="$SCRIPT_DIR"
VENV_PYTHON="$WORKING_DIR/venv/bin/python3"
CURRENT_USER=$(whoami)

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð² Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
if [ ! -f "$WORKING_DIR/run_bot.py" ]; then
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: run_bot.py Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² $WORKING_DIR"
    exit 1
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ
if [ ! -f "$VENV_PYTHON" ]; then
    echo "âš ï¸  Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ð² $WORKING_DIR/venv"
    echo "   Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ ÐµÐ³Ð¾: python3 -m venv venv"
    exit 1
fi

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ service Ñ„Ð°Ð¹Ð»
SERVICE_FILE="/etc/systemd/system/ml-bot.service"

echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ service Ñ„Ð°Ð¹Ð»Ð°: $SERVICE_FILE"
echo "   Working Directory: $WORKING_DIR"
echo "   User: $CURRENT_USER"
echo "   Python: $VENV_PYTHON"

sudo tee $SERVICE_FILE > /dev/null <<EOF
[Unit]
Description=ML Trading Bot
After=network.target

[Service]
Type=simple
User=$CURRENT_USER
WorkingDirectory=$WORKING_DIR
Environment="PATH=$WORKING_DIR/venv/bin"
ExecStart=$VENV_PYTHON $WORKING_DIR/run_bot.py
Restart=always
RestartSec=10
StandardOutput=append:$WORKING_DIR/logs/bot.log
StandardError=append:$WORKING_DIR/logs/errors.log

[Install]
WantedBy=multi-user.target
EOF

echo "âœ… Service Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½"

# ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ systemd
echo "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° systemd daemon..."
sudo systemctl daemon-reload

echo "âœ… ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
echo ""
echo "ðŸ’¡ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
echo "   sudo systemctl start ml-bot      # Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð±Ð¾Ñ‚Ð°"
echo "   sudo systemctl enable ml-bot     # Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº"
echo "   sudo systemctl status ml-bot     # ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ"
echo "   sudo journalctl -u ml-bot -f     # ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð»Ð¾Ð³Ð¾Ð²"
