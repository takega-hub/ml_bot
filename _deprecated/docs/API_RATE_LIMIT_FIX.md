# Исправление проблемы с Rate Limit API Bybit

## Проблема

Бот превышал лимиты API Bybit (ошибка `ErrCode: 10006 - Too many visits`), потому что делал слишком много запросов:

- **Основной цикл**: запрашивал свечи (kline) для каждого символа каждые 60 секунд
- **Цикл мониторинга позиций**: проверял позиции для каждого символа каждые 15 секунд

При 4 активных символах это приводило к **~20+ запросам в минуту**, что быстро достигало лимитов API.

## Решение

### 1. Оптимизация запросов позиций (ГЛАВНОЕ ИЗМЕНЕНИЕ)

**Было**: Отдельный API запрос для каждого символа
```python
for symbol in active_symbols:
    pos_info = bybit.get_position_info(symbol=symbol)  # 4 запроса для 4 символов
```

**Стало**: Один запрос для всех позиций USDT
```python
all_positions = bybit.get_position_info(settle_coin="USDT")  # 1 запрос для всех символов
```

**Эффект**: Снижение количества запросов на позиции в **4 раза** (с ~16 до ~4 запросов/минуту)

### 2. Задержка между обработкой символов

Добавлена 2-секундная пауза между обработкой разных символов в основном цикле:

```python
for symbol in active_symbols:
    await process_symbol(symbol)
    await asyncio.sleep(2)  # Пауза между символами
```

**Эффект**: Распределение нагрузки во времени вместо одновременных запросов

### 3. Увеличение интервалов

- **Цикл мониторинга позиций**: увеличен с 15 до 25 секунд
- **Интервал опроса по умолчанию**: увеличен с 60 до 120 секунд (`live_poll_seconds`)

**Эффект**: Общее снижение количества запросов на 30-40%

## Результат

### До оптимизации (4 символа):
- Запросы на свечи: ~4/минуту
- Запросы на позиции: ~16/минуту
- **ИТОГО: ~20 запросов/минуту**

### После оптимизации (4 символа):
- Запросы на свечи: ~2/минуту (с паузами между символами)
- Запросы на позиции: ~2.4/минуту (один запрос каждые 25 секунд)
- **ИТОГО: ~4-5 запросов/минуту** ✅

**Снижение нагрузки на API: ~75%**

## Дополнительные рекомендации

### Переменные окружения (.env)

Для дополнительного контроля можно настроить:

```bash
# Интервал между циклами (секунды)
LIVE_POLL_SECONDS=180  # Рекомендуется 120-300 для стабильности

# Ограничение активных символов
ACTIVE_SYMBOLS=BTCUSDT,ETHUSDT  # Торговать меньшим количеством пар
```

### Мониторинг

Следите за логами на наличие ошибок rate limit:
```bash
# Поиск ошибок rate limit в логах
grep "10006" logs/bot.log

# Проверка количества запросов
grep "pybit._http_manager" logs/bot.log | wc -l
```

## Технические детали

### Изменённые файлы

1. **bot/trading_loop.py**
   - Метод `_signal_processing_loop()`: добавлена задержка между символами
   - Метод `_position_monitoring_loop()`: оптимизация с одним запросом для всех позиций
   - Увеличен интервал проверки позиций с 15 до 25 секунд

2. **bot/config.py**
   - `live_poll_seconds`: изменено значение по умолчанию с 60 на 120 секунд

### Совместимость

Изменения **обратно совместимы**:
- Старые конфигурации продолжат работать
- Поведение API запросов оптимизировано без изменения логики торговли
- Все проверки позиций, breakeven и trailing stop работают как прежде

## Проверка работы

После перезапуска бота проверьте логи:

```bash
# Должны увидеть меньше запросов и отсутствие ошибок 10006
tail -f logs/bot.log | grep -E "(Starting.*Loop|rate limit|10006)"
```

Успешная работа:
- ✅ Нет ошибок "Too many visits" (10006)
- ✅ Сообщение "Starting Position Monitoring Loop..."
- ✅ Сообщение "Starting Signal Processing Loop..."
- ✅ Позиции обрабатываются корректно

## Отладка

Если проблемы с rate limit продолжаются:

1. **Увеличьте интервалы**:
   - `LIVE_POLL_SECONDS=300` (5 минут)
   - Уменьшите количество активных символов до 1-2

2. **Проверьте другие источники запросов**:
   - Telegram бот (может делать дополнительные запросы)
   - Другие скрипты, использующие тот же API ключ

3. **Свяжитесь с Bybit**:
   - Проверьте лимиты вашего аккаунта в личном кабинете
   - Для VIP аккаунтов лимиты могут быть выше

---

**Дата внедрения**: 2026-02-02
**Версия**: 1.0
**Статус**: ✅ Протестировано и работает
