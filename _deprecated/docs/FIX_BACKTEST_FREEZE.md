# Исправление зависания бэктеста при деплое

## Проблема
При деплое бота и тестировании моделей процесс зависает после генерации нескольких сигналов. Из логов видно, что последние записи показывают генерацию сигналов, но затем процесс останавливается.

## Причины
1. **Избыточное логирование** - в `bot/ml/strategy_ml.py` было много логирования на уровне INFO для каждого бара, что замедляет процесс
2. **Проблема с tqdm в неинтерактивном режиме** - прогресс-бар tqdm может блокировать выполнение при перенаправлении вывода или в неинтерактивном режиме
3. **Отсутствие обработки ошибок** - при обновлении прогресс-бара не было обработки ошибок

## Исправления

### 1. Уменьшено логирование в `bot/ml/strategy_ml.py`
Переведены следующие логи с INFO на DEBUG:
- `predict() начат` → DEBUG
- `prepare_features_with_df() завершен` → DEBUG
- `X_last подготовлен` → DEBUG
- `predict() завершен` → DEBUG
- `generate_signal() вызван` → DEBUG
- `Символ определен` → DEBUG
- `skip_feature_creation` → DEBUG

**Результат**: Логирование теперь происходит только на уровне DEBUG, что значительно ускоряет процесс в продакшене.

### 2. Улучшена обработка tqdm в `backtest_ml_strategy.py`
- Добавлена проверка интерактивного режима (`sys.stdout.isatty()` и `sys.stderr.isatty()`)
- В неинтерактивном режиме tqdm отключается автоматически
- Добавлена обработка ошибок при обновлении прогресс-бара
- В неинтерактивном режиме прогресс логируется через logger вместо tqdm

**Результат**: Бэктест не зависает в неинтерактивном режиме (деплой, cron, systemd).

### 3. Упрощен код прогресса
- Убраны все операции с прогресс-баром
- Прогресс логируется каждые 500 баров с информацией о:
  - Количестве обработанных баров
  - Проценте выполнения
  - Количестве сделок
  - Текущем балансе
  - Скорости обработки

**Результат**: Простой и надежный код без зависимостей от tqdm.

## Как проверить
1. Запустите бэктест в неинтерактивном режиме:
   ```bash
   python backtest_ml_strategy.py --model ml_models/xgb_BTCUSDT_15_mtf.pkl --symbol BTCUSDT --days 14 > output.log 2>&1
   ```

2. Проверьте, что процесс не зависает и завершается корректно

3. Проверьте логи - детальное логирование должно быть только на уровне DEBUG

## Дополнительные рекомендации
Если проблема все еще возникает:

1. **Проверьте уровень логирования**:
   ```python
   # В начале скрипта
   import logging
   logging.basicConfig(level=logging.WARNING)  # Только WARNING и выше
   ```

2. **Отключите tqdm полностью**:
   ```python
   # В backtest_ml_strategy.py
   use_tqdm = False  # Принудительно отключить
   ```

3. **Проверьте, нет ли других блокирующих операций**:
   - API вызовы без таймаутов
   - Файловые операции без обработки ошибок
   - Бесконечные циклы

## Статус
✅ Исправлено
- Логирование уменьшено (INFO → DEBUG для детальных логов)
- tqdm полностью удален (не нужен на сервере)
- Прогресс логируется через logger каждые 500 баров
- Упрощен код, убраны все зависимости от tqdm
