# Резюме улучшений ML стратегий

## Выполненные улучшения

### ✅ 1. Исправление генерации TP/SL
**Файл**: `bot/ml/strategy_ml.py`

**Что сделано**:
- Добавлены множественные проверки валидности TP/SL перед возвратом сигнала
- Принудительная установка fallback значений (SL=1%, TP=2.5%) если TP/SL невалидны
- Проверка логической корректности (для LONG: SL < цена < TP, для SHORT: TP < цена < SL)

**Результат**: Все сигналы LONG/SHORT теперь ВСЕГДА имеют валидные TP/SL.

### ✅ 2. Балансировка LONG/SHORT через class weights
**Файл**: `retrain_ml_optimized.py`

**Что сделано**:
- Улучшена логика расчета class weights с учетом дисбаланса LONG/SHORT
- Автоматическое определение minority class (LONG или SHORT)
- Увеличение веса minority class пропорционально дисбалансу (до 1.5x boost)

**Результат**: Модели будут лучше балансировать предсказания LONG/SHORT.

### ✅ 3. Динамический confidence threshold
**Файл**: `bot/ml/strategy_ml.py`

**Что сделано**:
- Добавлена адаптация порога на основе рыночных условий:
  - **Волатильность (ATR)**: высокая волатильность → выше порог (+20%)
  - **Сила тренда (ADX)**: слабый тренд → выше порог (+15%)
- Диапазон порога: 0.3 - 0.8

**Результат**: Стратегия адаптируется к рыночным условиям, фильтруя больше сигналов в неблагоприятных условиях.

### ✅ 4. Новые фичи
**Файл**: `bot/ml/feature_engineering.py`

**Добавленные фичи**:

1. **Волатильность**:
   - `realized_volatility_10`, `realized_volatility_20` - реализованная волатильность
   - `parkinson_vol`, `parkinson_vol_pct` - волатильность Паркинсона
   - `volatility_ratio` - отношение краткосрочной/долгосрочной волатильности

2. **Микроструктура рынка**:
   - `spread_proxy` - прокси bid-ask спреда
   - `volume_imbalance_5`, `volume_imbalance_10` - дисбаланс объема
   - `momentum_3`, `momentum_5`, `momentum_10` - импульс цены

3. **Трендовые**:
   - `di_plus`, `di_minus` - направление тренда (DI+ и DI-)
   - `adx_trend_up` - направление тренда по ADX

4. **Паттерны свечей**:
   - `is_doji` - паттерн Doji
   - `is_hammer` - паттерн Hammer
   - `is_shooting_star` - паттерн Shooting Star
   - `is_bullish_engulfing`, `is_bearish_engulfing` - паттерны Engulfing
   - `body_wick_ratio` - отношение тела к теням

5. **Уровни поддержки/сопротивления**:
   - `dist_to_support_pct`, `dist_to_resistance_pct` - расстояние до S/R в %
   - `dist_to_support_atr`, `dist_to_resistance_atr` - расстояние до S/R в ATR

**Результат**: Модели получат больше информации о рыночной структуре.

## Новые инструменты для анализа

### 1. `analyze_features.py`
Анализирует feature importance всех моделей.

**Использование**:
```bash
python analyze_features.py
```

**Что делает**:
- Извлекает feature importance из всех 15m моделей
- Показывает топ-20 самых важных фичей
- Сравнивает важность фичей между моделями
- Сохраняет результаты в `backtest_reports/feature_importance_analysis.csv`

### 2. `analyze_target_labeling.py`
Анализирует качество target labeling.

**Использование**:
```bash
python analyze_target_labeling.py
```

**Что делает**:
- Анализирует распределение классов (LONG/SHORT/HOLD)
- Проверяет достижимость TP для меток
- Выявляет дисбаланс классов
- Дает рекомендации по улучшению параметров

### 3. `run_diagnostics_direct.py`
Запускает бэктесты всех моделей для получения baseline.

**Использование**:
```bash
python run_diagnostics_direct.py
```

**Что делает**:
- Запускает бэктесты всех 15m моделей (14 дней, 20% депозита)
- Собирает статистику по каждой модели
- Сохраняет отчет в JSON формате

## Следующие шаги

### 1. Переобучить модели с новыми фичами
```bash
python retrain_ml_optimized.py --symbol BTCUSDT
python retrain_ml_optimized.py --symbol ETHUSDT
python retrain_ml_optimized.py --symbol SOLUSDT
```

### 2. Запустить бэктесты новых моделей
```bash
python backtest_ml_strategy.py --model ml_models/xgb_BTCUSDT_15_15m.pkl --days 14
python backtest_ml_strategy.py --model ml_models/rf_BTCUSDT_15_15m.pkl --days 14
# ... и т.д.
```

### 3. Сравнить результаты с baseline
- Win Rate должен быть > 45%
- Profit Factor должен быть > 1.5
- % сигналов с TP/SL должен быть > 95%

### 4. Анализ feature importance
```bash
python analyze_features.py
```

Проверить, какие новые фичи оказались важными.

### 5. Анализ target labeling
```bash
python analyze_target_labeling.py
```

Проверить качество меток и при необходимости скорректировать параметры.

## Ожидаемые улучшения

1. **Увеличение % сигналов с TP/SL** с ~30% до >95%
2. **Балансировка LONG/SHORT** - уменьшение дисбаланса с 2:1 до ~1.2:1
3. **Улучшение Win Rate** за счет динамического порога и новых фичей
4. **Улучшение Profit Factor** за счет лучшей фильтрации сигналов

## Важные замечания

1. **Все бэктесты должны использовать 20% депозита** (автоматически из `config.py`)
2. **Период тестирования: 14 дней** (более актуальные условия)
3. **После каждого изменения нужно переобучить модели** и запустить бэктесты
4. **Сравнивать результаты с baseline** (до улучшений)

## Проблемы, которые требуют дальнейшей работы

1. **MTF модели не генерируют сделки** - требуется исправление MTF фичей
2. **Оптимизация гиперпараметров** - требуется настройка для новых фичей
3. **Оптимизация весов ансамблей** - требуется настройка весов на основе Sharpe ratio
