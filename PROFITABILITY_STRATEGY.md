# Стратегия оптимизации прибыльности торгового бота (Single User)

## 1. Анализ текущего состояния и узких мест

### Проблемы (до оптимизации):
1. **Статичные параметры:** Использование фиксированных 3% SL и 1.5% TP не учитывало текущую волатильность рынка. В периоды затишья TP был недостижим, а в периоды шторма SL выбивало шумом.
2. **Медленная реакция:** Интервал опроса в 120 секунд (2 минуты) был слишком долгим для скальпинга/интрадея, что приводило к пропуску идеальных точек входа и выхода.
3. **Отсутствие метрик:** Не было удобного инструмента для быстрого анализа эффективности (PnL, Drawdown, Sharpe).

## 2. Реализованные меры оптимизации

### А. Динамическое управление рисками (ATR-based TP/SL)
В файл `strategy_ml.py` внедрена логика адаптации стоп-лосса и тейк-профита на основе ATR (Average True Range):
- **Логика:** Мы нормализуем текущий ATR относительно базового (0.5% для 15m).
- **Высокая волатильность (ATR > 0.5%):** Расширяем SL и TP (до 1.5x), чтобы избежать ложных выбиваний.
- **Низкая волатильность (ATR < 0.5%):** Сужаем SL и TP (до 0.8x), чтобы забирать прибыль даже на вялом рынке.
- **Ограничения:** Коэффициент адаптации ограничен диапазоном [0.8, 1.5] для безопасности.

### Б. Ускорение исполнения (Execution Speed)
В файле `config.py` оптимизирован параметр `live_poll_seconds`:
- **Было:** 120 секунд.
- **Стало:** 15 секунд.
- **Эффект:** Бот теперь реагирует на изменения рынка в 8 раз быстрее. Для 5 активных символов это безопасно с точки зрения лимитов API Bybit (обычно 10-20 запросов в секунду разрешено, а мы делаем серию раз в 15 сек).

### В. Система мониторинга (KPI Dashboard)
Создан скрипт `scripts/monitor_performance.py`, который анализирует историю сделок и выводит ключевые метрики:
- **Win Rate (%)**
- **Profit Factor** (Gross Profit / Gross Loss)
- **Max Drawdown** (Максимальная просадка)
- **Sharpe Ratio** (Коэффициент Шарпа)
- **Avg Win / Avg Loss**

## 3. План дальнейших действий и KPI

### Краткосрочные цели (1-2 недели):
1. **Сбор статистики:** Запустить бота с новыми настройками (ATR + 15s poll) и собрать минимум 50 сделок.
2. **Анализ:** Запускать `monitor_performance.py` ежедневно.
3. **Целевые KPI:**
   - **Win Rate:** > 55%
   - **Profit Factor:** > 1.5
   - **Max Drawdown:** < 10%

### Долгосрочные улучшения:
1. **Фильтр по волатильности (торговать только когда «есть движение»)** — ⚠️ **реализован, но показал ухудшение показателей, не рекомендуется**:
   - ATR(14) на 1h считается в бэктесте и в live; вход только если `atr_min_pct <= ATR_1h_pct <= atr_max_pct`.
   - **Конфиг:** `bot/config.py` — `atr_filter_enabled` (по умолчанию `false`), `atr_min_pct` (по умолчанию 0.3), `atr_max_pct` (2.0). Можно задать в `ml_settings.json`, через env (`ML_ATR_FILTER_ENABLED`, `ML_ATR_MIN_PCT`, `ML_ATR_MAX_PCT`) или **включить/выключить в админке бота** (Telegram: Настройки → ML стратегия → «Фильтр волатильности»).
   - **Бэктест:** `python backtest_ml_strategy.py --model <path> --atr-filter --atr-min 0.3 --atr-max 2.0` (пороги можно перебирать для подбора по PnL/Sharpe).
   - **Live:** фильтр в `trading_loop` перед открытием позиции; при выходе ATR за диапазон вход пропускается с логом.
   - **⚠️ Результаты тестирования:** фильтр показал снижение прибыльности, возможно из-за пропуска прибыльных сигналов в периоды низкой/высокой волатильности. По умолчанию отключен.
   - Подробно: [STRATEGY_IMPROVEMENTS_ROADMAP.md](STRATEGY_IMPROVEMENTS_ROADMAP.md) (п. 1).
2. **Feature Engineering:** Добавить в ML-модель данные из стакана (Order Book Imbalance) или объемы ликвидаций, если API позволяет.
3. **Ensemble Weighting:** Динамически менять веса моделей в ансамбле в зависимости от того, какая модель лучше перформит в текущем режиме рынка (тренд/флэт).

## 4. Инструкция по мониторингу
Для проверки результатов регулярно запускайте:
```bash
python scripts/monitor_performance.py
```
Это покажет актуальную картину прибыльности по всем парам.

## 5. Сбор статистики на 50 сделок
⚠️ **Примечание:** Фильтр волатильности (ATR filter) показал ухудшение показателей и не рекомендуется к использованию. По умолчанию отключен.

1. ~~Включите фильтр: в `ml_settings.json` задайте `"atr_filter_enabled": true`, `"atr_min_pct": 0.3`, `"atr_max_pct": 2.0` (или через env `ML_ATR_FILTER_ENABLED=1`).~~ **Не рекомендуется**
2. Запустите бота и дождитесь минимум 50 сделок по активным парам.
3. Ежедневно запускайте `python scripts/monitor_performance.py`, фиксируйте Win Rate, Profit Factor, Max Drawdown, Sharpe.
4. Целевые KPI: Win Rate > 55%, Profit Factor > 1.5, Max Drawdown < 10%.
